name: IQ Server Scan - Full Repository

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  iq_scan:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clonar o reposit√≥rio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Java (requerido pelo IQ Server)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3Ô∏è‚É£ Compactar o c√≥digo-fonte do reposit√≥rio
      - name: Compactar reposit√≥rio
        run: zip -r source.zip .

      # 4Ô∏è‚É£ Testar autentica√ß√£o com o IQ Server (verificar se o token/user funciona)
      - name: Testar conex√£o com IQ Server
        env:
          IQ_USER: ${{ secrets.IQ_USER }}
          IQ_PASSWORD: ${{ secrets.IQ_PASSWORD }}
        run: |
          echo "üîπ Testando autentica√ß√£o com o Sonatype IQ Server..."
          curl -v -u "$IQ_USER:$IQ_PASSWORD" \
               "https://hairlike-cami-fiercely.ngrok-free.dev/api/v2/organizations"

      # 5Ô∏è‚É£ Enviar c√≥digo para o IQ Server e rodar o SCA
      - name: Executar SCA no IQ Server
        env:
          IQ_USER: ${{ secrets.IQ_USER }}
          IQ_PASSWORD: ${{ secrets.IQ_PASSWORD }}
          IQ_APPLICATION_ID: ${{ secrets.IQ_APPLICATION_ID }}
        run: |
          echo "üöÄ Enviando c√≥digo-fonte para an√°lise no IQ Server..."
          curl -v -u "$IQ_USER:$IQ_PASSWORD" \
               -F "applicationId=$IQ_APPLICATION_ID" \
               -F "scan=@source.zip" \
               "https://hairlike-cami-fiercely.ngrok-free.dev/api/v2/scan/applications/$IQ_APPLICATION_ID/sources"
